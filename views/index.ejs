<!DOCTYPE html>
<html>
  <head>
    <title>LDAP 기반 웹 애플리케이션</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel='stylesheet' href='/stylesheets/textbox.css' />
  </head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <body>

      <%-include("layout/header") %>

    <div class="main">

      <h1>LDAP 기반 웹 애플리케이션</h1>
      
      <% if (user) { %>
        <h1><%= user %> 님 환영합니다.!</h1>
        <a href="/user/logout"><button class="button">로그아웃 </button></a><br/>
      <% }else{ %>
        <a onclick="toggleLoginForm();"><button class="button">로그인 </button></a><br/>
        <a onclick="toggleRegisterForm();"><button class="button">회원가입 </button></a><br/>
      <% } %>
      <a href = "/other/web"><button class="button">모든 정보 가져오기 </button></a><br/>
      <a onclick="getOu('ou=department');"><button class="button">개발자 페이지 </button></a><br/>

      <!-- 로그인 폼 -->
      <form action="/user/bind" method="post">
        <div id="loginForm" style="display: none">
            부서 : <select name="ou" id="selectOu">
              </select>
          이름 : <input type="text" name="username" id="input_loginUsername" placeholder="대표이름"> <br>
          <label for="input_loginPassword">비밀번호</label>
          <input type="password" name="password" id="input_loginPassword" placeholder="당신의 비밀번호"> <br>
          <input type="submit" value="로그인 하기" class="button">
        </div>
      </form>

      <br>

      <!-- 회원가입 폼 -->
      <form action="/user/add" method="post">
          <div id="registerForm" style="display: none">
            성 <input type="text" name="gn" placeholder="성[GN]"> <br>
            이름 <input type="text" name="sn" placeholder="이름[sn]"> <br>
            대표이름 <input type="text" name="displayName" placeholder="대표이름[displayName]"> <br>

            부서 : <select name="ou" id="selectOu">
            </select>
            그룹 : <select name="gidNumber" id="selectGroup">
            </select>
            유저번호 <input type="text" name="un" placeholder="유저번호[un]"> <br>
              비밀번호 <input type="password" name="password" placeholder="비밀번호[password]"> <br>
              <input type="hidden" name="groupData" value = "">
              <input type="submit" value="회원가입 하기" class="button"> 
          </div>
      </form>
    </div>

    <%-include("layout/footer") %>

    <script>
    let ouResults ;
    let ouLength;

    let groupResults;
    let groupLength;
    </script>

    <script>
      let isLogin = false;
      let isRegister = false;
      let toggleLoginForm = () =>{
        if(isRegister){ 
          isRegister = !isRegister;
          $("#registerForm").toggle();     
        }
        isLogin = !isLogin;
        getOu(`ou=department`);
        $("#loginForm").toggle();
      }
      let toggleRegisterForm = () =>{
        if(isLogin){ 
          isLogin = !isLogin;
          $("#loginForm").toggle();   
        }
        isRegister = !isRegister;
        getOu(`ou=department`);
        getGroups(`ou=groups`);
        $("#registerForm").toggle();
      }
    </script>
    <script>
      let createOuOptions = (length,results) =>{
        $("#selectOu").empty();
        for(let i=0; i<length; i++){
          let option = $(`<option value=${results[i].ou}>${results[i].businessCategory}</option>`);
          $("#selectOu").append(option);
        }
      }
      let createGroupOptions = (length,results) =>{
        $("#selectGroup").empty();
        for(let i=0; i<length; i++){
          let option = $(`<option value=${results[i].gidNumber}>${results[i].description}</option>`);
          $("#selectGroup").append(option);
        }
      }
    </script>
    <script>
    let getOu = (baseDn) => {
            console.log("getOu Ajax  " +baseDn);
            $.ajax({
                url: '/ou/child/'+baseDn,          
                dataType: 'json',                
                type: 'GET',
                data : {},
                    success: (result) => {
                      console.log(`결과 : ${result}`);
                      ouResults = result;
                      ouLength = result.length;
                    },
                    err: (req,status,err) =>{
                      alert("code = "+ req.status + " message = " + req.responseText + " error = " + err); // 실패 시 처리
                    },
                    complete : (data) =>{
                      console.log(`ouResults : ${ouResults}`);
                      console.log(`ouLength : ${ouLength}`);
                      createOuOptions(ouLength,ouResults);
                    }
                    }); 
        }
        let getGroups = (baseDn) => {
            console.log("getGroups Ajax  " +baseDn);
            $.ajax({
                url: '/group/child/'+baseDn,          
                dataType: 'json',                
                type: 'GET',
                data : {},
                    success: (result) => {
                      console.log(`결과 : ${result}`);
                      groupResults = result;
                      groupLength = result.length;
                    },
                    err: (req,status,err) =>{
                      alert("code = "+ req.status + " message = " + req.responseText + " error = " + err); // 실패 시 처리
                    },
                    complete : (data) =>{
                      console.log(`ouResults : ${groupResults}`);
                      console.log(`ouLength : ${groupLength}`);
                      createGroupOptions(groupLength,groupResults);
                    }
                    }); 
        }
    </script>
  </body>

</html>
